\chapter{Analysis and Design}
\label{chapter:analysis.design}

Warlock is a distributed consensus service custom made to be used as a
lock manger. In this chapter, we discuss the design of the system based on the 
requirements detailed in \chapterref{requirements}. We explain the structure 
of the system and then detail how it maps on to to the specified requirements.

\section{Architecture}

The Warlock system can be divided into different components based on their
functionality as shown in figure \figureref{warlock.arch}.

\begin{figure}
  \captionstyle{\raggedright}

  % Generated with LaTeXDraw 2.0.7
  % Tue Aug 14 12:18:36 CEST 2012
  % \usepackage[usenames,dvipsnames]{pstricks}
  % \usepackage{epsfig}
  % \usepackage{pst-grad} % For gradients
  % \usepackage{pst-plot} % For axes
  \scalebox{1} % Change this value to rescale the drawing.
  {
    \begin{pspicture}(0,-4.3)(16.642187,4.3)
      \psframe[linewidth=0.038,dimen=outer](16.6,0.9)(0.0,-4.3)
      \psframe[linewidth=0.038,dimen=outer](4.6,0.5)(0.4,-1.5)
      \psframe[linewidth=0.038,dimen=outer](10.4,0.5)(6.2,-1.5)
      \psframe[linewidth=0.038,dimen=outer](16.2,0.5)(12.0,-1.5)
      \psframe[linewidth=0.038,dimen=outer](14.2,-2.9)(2.8,-3.9)
      \psline[linewidth=0.038cm,arrowsize=0.05291667cm 2.0,arrowlength=0.45,arrowinset=0.4,doubleline=true,doublesep=0.12]{<->}(4.8,-0.5)(6.0,-0.5)
      \psline[linewidth=0.038cm,arrowsize=0.05291667cm 2.0,arrowlength=0.45,arrowinset=0.4,doubleline=true,doublesep=0.12]{<->}(10.6,-0.5)(11.8,-0.5)
      \psline[linewidth=0.038cm,arrowsize=0.05291667cm 2.0,arrowlength=0.45,arrowinset=0.4,doubleline=true,doublesep=0.12]{<->}(8.4,-1.7)(8.4,-2.7)
      \psline[linewidth=0.038cm,arrowsize=0.05291667cm 2.0,arrowlength=0.45,arrowinset=0.4,doubleline=true,doublesep=0.12]{<->}(3.8,-1.7)(3.8,-2.7)
      \psline[linewidth=0.038cm,arrowsize=0.05291667cm 2.0,arrowlength=0.45,arrowinset=0.4,doubleline=true,doublesep=0.12]{<->}(13.0,-1.7)(13.0,-2.7)
      \usefont{T1}{ptm}{m}{n}
      \rput(2.5571876,-0.395){Consensus}
      \usefont{T1}{ptm}{m}{n}
      \rput(8.259844,-0.395){Server}
      \usefont{T1}{ptm}{m}{n}
      \rput(14.051719,-0.395){Database}
      \usefont{T1}{ptm}{m}{n}
      \rput(8.332812,-3.395){Utilities}
      \usefont{T1}{ptm}{m}{n}
      \rput(15.98875,1.225){Warlock}
      \psline[linewidth=0.038cm,arrowsize=0.05291667cm 2.0,arrowlength=0.45,arrowinset=0.4,doubleline=true,doublesep=0.12]{<->}(8.4,2.1)(8.4,1.1)
      \psframe[linewidth=0.038,dimen=outer](10.4,4.3)(6.2,2.3)
      \usefont{T1}{ptm}{m}{n}
      \rput(8.21375,3.405){Client}
    \end{pspicture} 
  }


  \caption[Warlock Architecture]{%
    The figure shows the high level view of Warlock with its components and the 
    messaging/dependeicies between them.}
    \label{figure:warlock.arch}
  \normalcaption
\end{figure}

The figure shows the internal components of Warlock and the dependencies between
them.

\subsection{Utilities}

The utilities component provides the rest of the Warlock components with 
commonly used modules. The library consists of

\begin{itemize}
    \iterm{Configuration Helper}: Reads configuration files to be used as 
    settings for Warlock.
    \iterm{Hash Table}: A hash table implementation based on ETS and dict. [[]]
\end{itemize}

\subsection{Server}

The server component of Warlock ties all the other components together and 
indirectly routes messages between them. It provides the below functionalities:

\begin{itemize}
    \iterm{Handle client connections}: Server manages the incoming client 
    connections which can then send requests.
    \iterm{Callback}: Server provides the callback module that is executed
    once the request is processed.
    \iterm{Console}: Server provides interface that allows us to interact with
    Warlock from the console.
    \iterm{Replication}: Server setups connection between two servers and 
    oversees the data transfer between them when a new node is being added to
    the cluster.
\end{itemize}

\subsection{Database}

The database component is used to store all the data and provides at its
least the simple API required for a key value store. It has a pluggable backend 
which allows us to use different backends as needed.

Besides the hash table interface, the database component can provide data
backup and restore functions that can be used by the server component to
enable the Warlock feature of adding nodes dynamically.

\subsection{Consensus}

The consensus component is the core of Warlock. It uses a modified version of 
the Paxos algorithm from \citet{Robbert2011} for its implementation. It also
uses ideas from \citet{LamportSP08} and \citet{LamportMZ10} to allow for
a dynamic cluster.

\subsection{Key Value Store}

\subsection{Master lease}

\subsection{Read Write separation}

local, cluster operations

\subsection{Routing}

\subsection{Multiple operations}

pipelining?

\subsection{Performance optimizations}

\section{Modules}

\subsection{DB}

\subsection{Utils}

\subsection{Server}

\subsection{Consensus}

{architeture diagram}

{timing diagram} - move to concepts?

\section{API design}

\section{Dynamic cluster}

cluster setup

maintenance

\section{Failure Recovery}

fault tolerance

\section{Pluggable Backends}

What is it?

Why do we need it?

\section{Client}

Current state

Why do we need it


